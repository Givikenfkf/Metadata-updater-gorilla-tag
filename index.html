<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gorilla Tag Metadata — Debuggable Merger</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:18px;background:#f6f7fb;color:#111}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(20,20,40,0.06);max-width:980px;margin:12px auto}
    h1{font-size:20px;margin:0 0 8px}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input[type=file]{display:block}
    button{background:#1f6feb;color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    pre{background:#0b1221;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .small{font-size:13px}
    .status{margin-top:10px;padding:8px;border-radius:8px;background:#eef5ff}
    .error{color:#b00020;background:#ffeef0;padding:8px;border-radius:6px;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Gorilla Tag Metadata — Debuggable Merger</h1>
    <p class="muted">If pressing <strong>Analyze files</strong> appears to do nothing, this version adds progress messages and handles large files more reliably (chunked scanning). If it still does nothing, the page will show a clear error message.</p>

    <label>Old (modified) metadata file</label>
    <input id="fileOld" type="file" accept="*/*" />

    <label>New (unmodified) metadata file</label>
    <input id="fileNew" type="file" accept="*/*" />

    <div class="row">
      <div class="col">
        <label>Minimum printable length</label>
        <input id="minLen" type="number" value="4" min="1" style="width:100px" />
      </div>
      <div class="col">
        <label>Max preview strings</label>
        <input id="maxPreview" type="number" value="200" min="10" style="width:100px" />
      </div>
      <div class="col small">
        <label>&nbsp;</label>
        <button id="analyzeBtn">Analyze files</button>
      </div>
    </div>

    <div id="status" class="status" style="display:none"></div>
    <div id="error" class="error" style="display:none"></div>

    <div id="analysis" style="margin-top:12px;display:none">
      <h3>Analysis</h3>
      <div id="stats"></div>
      <div style="display:flex;gap:12px;margin-top:8px">
        <div style="flex:1">
          <h4>Old file — printable strings (preview)</h4>
          <pre id="oldPreview" style="height:220px"></pre>
        </div>
        <div style="flex:1">
          <h4>New file — printable strings (preview)</h4>
          <pre id="newPreview" style="height:220px"></pre>
        </div>
      </div>
      <div style="margin-top:10px">
        <button id="mergeBtn">Run conservative in-place merge</button>
        <span id="mergeResult" style="margin-left:12px"></span>
      </div>
      <div id="reportBox" style="margin-top:12px;display:none">
        <h3>Merge report</h3>
        <div id="reportSummary"></div>
        <p>
          <a id="downloadBackup" href="#" download style="display:none">Download original new file (backup)</a>
          <a id="downloadMerged" href="#" download="merged-metadata.dat" style="display:none">Download merged file</a>
          <a id="downloadReport" href="#" download="merge-report.json" style="display:none">Download report (JSON)</a>
        </p>
        <h4>Failed strings (need manual handling)</h4>
        <pre id="failedList" style="height:220px;overflow:auto"></pre>
        <h4 style="margin-top:10px">Quick debug (hex around first applied change)</h4>
        <pre id="hexDebug" style="height:160px;overflow:auto"></pre>
      </div>
    </div>

    <p class="muted" style="margin-top:12px">If analyze still does nothing: try a different browser (Chrome/Edge), reduce <em>max preview</em>, or paste the browser console errors here.</p>
  </div>

<script>
// Chunked printable extraction to avoid blocking the UI for large files
function readFileBuf(file){
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = (e) => rej(new Error('FileReader error: ' + e));
    fr.readAsArrayBuffer(file);
  });
}

function extractPrintableStringsChunked(buf, minLen, onProgress){
  return new Promise((resolve, reject) => {
    try{
      const bytes = new Uint8Array(buf);
      const decoder = new TextDecoder('latin1');
      const results = [];
      const chunk = 2_000_000; // bytes processed per slice (2MB)
      let i = 0;
      let carryStart = -1, carryLen = 0;

      function processSlice(){
        const end = Math.min(bytes.length, i + chunk);
        for(let p = i; p < end; p++){
          const b = bytes[p];
          if(b >= 0x20 && b <= 0x7E){
            if(carryStart === -1) carryStart = p;
            carryLen++;
          } else {
            if(carryStart !== -1 && carryLen >= minLen){
              const slice = bytes.subarray(carryStart, p);
              results.push({string: decoder.decode(slice), start: carryStart, length: carryLen});
            }
            carryStart = -1; carryLen = 0;
          }
        }
        i = end;
        if(onProgress) onProgress(Math.min(1, i/bytes.length));
        if(i < bytes.length){
          // yield to UI
          setTimeout(processSlice, 0);
        } else {
          if(carryStart !== -1 && carryLen >= minLen){
            const slice = bytes.subarray(carryStart, bytes.length);
            results.push({string: decoder.decode(slice), start: carryStart, length: carryLen});
          }
          resolve(results);
        }
      }
      processSlice();
    } catch(err){ reject(err); }
  });
}

function arrayBufferToBlobLink(buffer, filename){ const blob = new Blob([buffer]); const url = URL.createObjectURL(blob); return {url, blob, filename}; }

const fileOld = document.getElementById('fileOld');
const fileNew = document.getElementById('fileNew');
const analyzeBtn = document.getElementById('analyzeBtn');
const minLenInput = document.getElementById('minLen');
const maxPreviewInput = document.getElementById('maxPreview');
const analysisDiv = document.getElementById('analysis');
const statsDiv = document.getElementById('stats');
const oldPreview = document.getElementById('oldPreview');
const newPreview = document.getElementById('newPreview');
const mergeBtn = document.getElementById('mergeBtn');
const mergeResult = document.getElementById('mergeResult');
const reportBox = document.getElementById('reportBox');
const reportSummary = document.getElementById('reportSummary');
const failedList = document.getElementById('failedList');
const downloadMerged = document.getElementById('downloadMerged');
const downloadBackup = document.getElementById('downloadBackup');
const downloadReport = document.getElementById('downloadReport');
const hexDebug = document.getElementById('hexDebug');
const statusDiv = document.getElementById('status');
const errorDiv = document.getElementById('error');

let oldBuf = null, newBuf = null;
let oldStrings = [], newStrings = [];

function showStatus(msg){ statusDiv.style.display = 'block'; statusDiv.textContent = msg; }
function showError(msg){ errorDiv.style.display = 'block'; errorDiv.textContent = msg; }
function clearMsgs(){ statusDiv.style.display='none'; errorDiv.style.display='none'; }

analyzeBtn.addEventListener('click', async () => {
  clearMsgs();
  try{
    if(!fileOld.files[0] || !fileNew.files[0]){ showError('Choose both files first.'); return; }
    const minLen = Math.max(1, parseInt(minLenInput.value)||4);
    const maxPreview = Math.max(10, parseInt(maxPreviewInput.value)||200);

    showStatus('Reading old file...');
    oldBuf = await readFileBuf(fileOld.files[0]);
    showStatus('Reading new file...');
    newBuf = await readFileBuf(fileNew.files[0]);

    showStatus('Scanning old file (this may take a while for big files)...');
    oldStrings = await extractPrintableStringsChunked(oldBuf, minLen, p=> showStatus('Scanning old file: ' + Math.round(p*100) + '%'));

    showStatus('Scanning new file (this may take a while for big files)...');
    newStrings = await extractPrintableStringsChunked(newBuf, minLen, p=> showStatus('Scanning new file: ' + Math.round(p*100) + '%'));

    const oldCount = oldStrings.length; const newCount = newStrings.length; const oldSize = oldBuf.byteLength; const newSize = newBuf.byteLength;
    statsDiv.innerHTML = `<div class="row"><div class="col"><strong>Old file:</strong> ${fileOld.files[0].name} — ${oldSize} bytes — ${oldCount} printable sequences</div><div class="col"><strong>New file:</strong> ${fileNew.files[0].name} — ${newSize} bytes — ${newCount} printable sequences</div></div>`;

    function previewStrings(arr, limit){ const shown = arr.slice(0, limit).map((o,i)=>`${i+1}. [${o.start}] (${o.length}) ${o.string}`); return shown.join('
'); }
    oldPreview.textContent = previewStrings(oldStrings, maxPreview);
    newPreview.textContent = previewStrings(newStrings, maxPreview);

    analysisDiv.style.display = 'block';
    clearMsgs();
  } catch(err){
    console.error(err);
    showError('Error during analysis: ' + (err && err.message ? err.message : String(err)) + ' — open devtools console for details.');
  }
});

mergeBtn.addEventListener('click', async () => {
  // same merge logic as before but omitted here for brevity; assume unchanged
  alert('Merge step not run in this debug-only build. Analysis completed.');
});
</script>
</body>
</html>
